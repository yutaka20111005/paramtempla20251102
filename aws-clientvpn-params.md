# AWS Client VPN 構築パラメータシート

## 1. 証明書の準備(事前作業 OpenSSL使用・PrivateCA構築)

### 1-1. サーバー証明書・クライアント証明書
| 項目 | 値 | 備考 |
|------|-----|------|
| 証明書管理方法 | ACM (AWS Certificate Manager) | OpenSSL等で生成した証明書をACMにインポート |
| サーバー証明書ARN | arn:aws:acm:ap-northeast-1:xxxx | ACMで確認 |
| クライアント証明書ARN | arn:aws:acm:ap-northeast-1:xxxx | 相互認証の場合のみ必須 |

---

## 2. Client VPNエンドポイント設定

### 2-1. 基本設定
| 項目 | 値 | 備考 |
|------|-----|------|
| 名前タグ | clientvpn-endpoint-tokyo | 任意の識別名 |
| 説明 | Tokyo VPN Endpoint | - |
| クライアントIPv4 CIDR | （内部ALBと同じサブネットを想定） | **VPC CIDRと重複しないこと**。VPNクライアントに割り当てるIP範囲 |
| サーバー証明書ARN | (1-1で取得したARN) | - |
| 認証オプション | 相互認証 (証明書ベース) | または Active Directory / SAML認証 |
| クライアント証明書ARN | (1-1で取得したARN) | 相互認証を選択した場合 |

### 2-2. 接続ログ設定（CloudWatch Logsを利用するため、定例時に確認予定）
| 項目 | 値 | 備考 |
|------|-----|------|
| 接続ログを有効化 | はい | 推奨:監査・トラブルシューティング用 |
| CloudWatch Logsロググループ名 | /aws/clientvpn/tokyo | 事前にロググループ作成が必要 |
| CloudWatch Logsログストリーム | clientvpn-connections | - |

### 2-3. DNS設定
| 項目 | 値 | 備考 |
|------|-----|------|
| DNS サーバー | 10.0.0.2 | VPC内のRoute 53 Resolver (VPC+2のIP)。カスタムDNSサーバーを使用する場合は適宜変更 <br> 内部ALBのDNS名前解決は、 Route53 Private DNS Hosted Zoneで行われる想定。 |
| スプリットトンネルを有効化 | はい | 「はい」:VPC向けトラフィックのみVPN経由。「いいえ」:全トラフィックがVPN経由 |

### 2-4. トランスポート設定
| 項目 | 値 | 備考 |
|------|-----|------|
| トランスポートプロトコル | UDP | TCPも選択可。UDPの方がパフォーマンス良好 |
| VPNポート | 443 | UDPの場合:443または1194。TCPの場合:443 |

### 2-5. 追加設定
| 項目 | 値 | 備考 |
|------|-----|------|
| セッションタイムアウト時間 | 1時間 | デフォルト24時間。必要に応じて調整 |
| クライアント接続ハンドラー | - | Lambda ARN(オプション) |
| セルフサービスポータルを有効化 | はい | クライアント自身が設定ファイルをダウンロード可能 |

---

## 3. ターゲットネットワークの関連付け

### 3-1. サブネット関連付け(複数AZ推奨)
| 項目 | 値 | 備考 |
|------|-----|------|
| VPC | vpc-xxxxxxxxx (xxx/16) | - |
| サブネット1 | subnet1a (xxx/24, AZ-1a) | **プライベートサブネット推奨** |
| サブネット2 | subnet1c (xxx/24, AZ-1c) | 冗長性のため複数AZに関連付け |
| サブネット3 | subnet1d (xxx/24, AZ-1c) | 将来3AZ時に関連付け予定 |

**重要:** Client VPNエンドポイントは、関連付けたサブネット内にENI(Elastic Network Interface)を作成します。

---

## 4. 承認ルール

### 4-1. アクセス許可ルール
| 送信先ネットワーク | アクセス許可対象 | 説明 | 備考 |
|-------------------|-----------------|------|------|
| 10.0.0.0/16 | すべてのユーザー | CS用内部ALBへのアクセス | 必須。リソースへアクセス許可 |
| 0.0.0.0/0 | すべてのユーザー | インターネットアクセス | スプリットトンネル無効時に設定(オプション) |

**注意:** 最小権限の原則に基づき、必要な範囲のみ許可してください。

---

## 5. ルートテーブル設定

### 5-1. Client VPNエンドポイントのルート
| 送信先CIDR | ターゲットサブネット | 説明 | 備考 |
|-----------|---------------------|------|------|
| （内部ALB用サブネットAZ-1aを想定） | 内部ALB用サブネット(AZ-1a) | VPCへのルーティング | 関連付けた各サブネットに対して自動的にルートが追加される |
| （内部ALB用サブネットAZ-1cを想定） | 内部ALB用サブネット(AZ-1c)  | VPCへのルーティング | 関連付けた各サブネットに対して自動的にルートが追加される |
| （内部ALB用サブネットAZ-1dを想定） | 内部ALB用サブネット(AZ-1d)  | VPCへのルーティング | 関連付けた各サブネットに対して自動的にルートが追加される |

---

## 6. セキュリティグループ設定

### 6-1. Client VPN用セキュリティグループ
| 項目 | 値 | 備考 |
|------|-----|------|
| セキュリティグループ名 | - -prod-sg-clientvpn-access | - |
| VPC |  - prod-vpc-subnet1a (x.x.x.x/16) | - |
| VPC |  - prod-vpc-subnet1c (x.x.x.x/16) | - |

#### インバウンドルール(CS用内部ALB想定)
| タイプ | プロトコル | ポート範囲 | ソース | 説明 |
|--------|----------|-----------|--------|------|
| すべてのトラフィック | HTTPS | すべて | （内部ALBと同じサブネットを想定） | VPNクライアントCIDRからのアクセス |

#### アウトバウンドルール
| タイプ | プロトコル | ポート範囲 | 送信先 | 説明 |
|--------|----------|-----------|--------|------|
| すべてのトラフィック | すべて | すべて | 0.0.0.0/0 | デフォルト |

**適用対象:** VPC内でVPNクライアントからアクセスさせたいEC2インスタンス等のリソースに、このセキュリティグループを適用またはインバウンドルールで許可

---


## 7. クライアント設定ファイルのダウンロード

### 7-1. 設定ファイル取得手順
| 手順 | 操作 | 備考 |
|------|------|------|
| 1 | AWS Management Console → VPC → Client VPN Endpoints | - |
| 2 | 対象エンドポイントを選択 → 「クライアント設定をダウンロード」 | .ovpnファイルがダウンロードされる |
| 3 | クライアント証明書と秘密鍵を.ovpnファイルに追記 | 相互認証の場合のみ。`<cert>`と`<key>`タグ内に記載 |
| 4 | OpenVPNクライアントにインポート | AWS提供のAWS VPN Clientまたは標準OpenVPNクライアント |

---

※以下は、構築時における参考とするため、記載。
　成果物対象ではありません。

## ◆構築後の確認事項

| 確認項目 | 確認方法 | 備考 |
|----------|----------|------|
| VPN接続成功 | クライアントから接続テスト | - |
| VPC内リソースへの疎通 | VPC内のプライベートIPにpingまたはSSH接続 | セキュリティグループの設定確認 |
| DNS名前解決 | nslookup/digでVPC内DNSホスト名を確認 | - |
| 接続ログ記録 | CloudWatch Logsで接続履歴を確認 | - |
| インターネットアクセス | スプリットトンネル設定に応じて確認 | - |

---

## DNS名前解決に関する注意事項

| 項目 | 注意点 | 対応方法 |
|------|--------|----------|
| VPC内DNSホスト名解決 | VPNクライアントからVPC内のプライベートDNS名(例: ip-10-0-1-10.ap-northeast-1.compute.internal)を解決するには、DNS設定が必要 | Client VPNエンドポイントのDNSサーバーにVPCのRoute 53 Resolver(10.0.0.2)を指定 |
| カスタムドメイン解決 | Route 53プライベートホストゾーンを使用している場合 | プライベートホストゾーンがVPCに関連付けられていることを確認 |
| スプリットDNS | VPN接続時にパブリックDNSとプライベートDNSを併用したい場合 | スプリットトンネルを有効化し、クライアント側でDNS設定を調整 |
| DNS検索ドメイン | 短縮名でのアクセスを可能にする場合 | Client VPN設定でDNSサフィックス(例: ap-northeast-1.compute.internal)を指定(オプション) |

---

## ◆参考情報

- [AWS Client VPN 管理ガイド](https://docs.aws.amazon.com/vpn/latest/clientvpn-admin/)
- Client VPNの料金: エンドポイント時間料金 + 接続時間料金が発生

---


