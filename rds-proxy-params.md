# AWS RDS Proxy 構築パラメータシート

## 基本情報

| 項目 | 設定値 | 備考 |
|------|--------|------|
| リージョン | ap-northeast-1 (Tokyo) | 東京リージョン |
| プロキシ識別子 | aurora-pg-proxy-prod | 任意の名前を設定 |
| エンジンファミリー | POSTGRESQL | Aurora PostgreSQL用 |
| エンジンの互換性 | PostgreSQL 13以降 | Serverless v2対応バージョン |

## ターゲットグループ設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| ターゲットグループ名 | default | 自動生成される |
| データベース | aurora-pg-serverless-v2-cluster | Aurora PostgreSQL Serverless v2クラスター名 |
| 接続プールの最大接続数 | 100 | 最小値: 1、最大値: 100（デフォルト）。DBインスタンスの最大接続数を考慮して設定 |
| セッションピン留めフィルター | なし | 必要に応じて設定（例: EXCLUDE_VARIABLE_SETS） |
| 接続借用タイムアウト | 120秒 | デフォルト値。必要に応じて調整 |
| 初期化クエリ | - | 接続時に実行するSQL文（任意） |

## 接続設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| Secrets Manager シークレット | rds-proxy-secret-aurora-pg | データベース認証情報を格納したシークレット |
| IAM認証 | 無効 | 必要に応じて有効化 |
| クライアント認証タイプ | SECRETS | Secrets Managerを使用 |

## アイドル接続設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| アイドルクライアント接続のタイムアウト | 1800秒（30分） | 推奨値: 1800秒。未使用接続の自動切断時間 |

## ネットワーク設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| VPC | vpc-xxxxx (10.0.0.0/16) | 既存VPCを選択 |
| サブネット | subnet-xxxxx (10.0.1.0/24, AZ: ap-northeast-1a)<br>subnet-yyyyy (10.0.2.0/24, AZ: ap-northeast-1c) | 最低2つのAZにサブネットが必要 |
| パブリックアクセス可能 | いいえ | セキュリティ上、プライベート推奨 |
| セキュリティグループ | sg-rds-proxy | PostgreSQLポート（5432）のインバウンドルールを設定 |

## セキュリティグループルール

| タイプ | プロトコル | ポート範囲 | ソース | 備考 |
|--------|----------|----------|--------|------|
| PostgreSQL | TCP | 5432 | アプリケーション層SG または 10.0.0.0/16 | アクセス元を適切に制限 |

## IAMロール設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| IAMロール | AWSServiceRoleForRDSProxy | 自動作成または既存ロールを選択 |
| 必要な権限 | - SecretsManagerReadWrite<br>- KMS復号化権限 | Secrets Managerへのアクセス権限が必要 |

## TLS/SSL設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| TLS/SSLを必須にする | いいえ | セキュリティ要件に応じて「はい」に変更 |
| TLSバージョン | TLS 1.2以降 | 推奨設定 |

## 拡張ロギング設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| 拡張ロギング | 無効 | トラブルシューティング時は有効化を検討 |

## タグ設定

| キー | 値 | 備考 |
|------|-----|------|
| Name | aurora-pg-proxy-prod | リソース識別用 |
| Environment | production | 環境識別 |
| ManagedBy | terraform / cloudformation / manual | 管理方法を記載 |
| Application | your-app-name | アプリケーション名 |

## Serverless v2 対応に関する注意事項

1. **オートスケーリング対応**: RDS Proxyは自動的にServerless v2のスケーリングに対応します
2. **接続プール管理**: Serverless v2のACU変動に応じて接続が自動調整されます
3. **ウォームアップ**: コールドスタート時の接続確立時間を考慮してください
4. **最小ACU設定**: Serverless v2クラスター側で適切な最小ACUを設定することを推奨（0.5 ACU以上）

## 構築前チェックリスト

- [ ] Secrets Managerにデータベース認証情報が登録済み
- [ ] IAMロールに必要な権限が付与済み
- [ ] セキュリティグループのインバウンドルールが適切に設定済み
- [ ] Aurora PostgreSQL Serverless v2クラスターが稼働中
- [ ] 選択したサブネットがプライベートサブネットであることを確認
- [ ] VPCエンドポイント（Secrets Manager用）の設定を検討（オプション）

## 構築後の確認事項

- [ ] RDS Proxyのエンドポイントで接続できることを確認
- [ ] CloudWatch Logsで接続ログを確認
- [ ] 接続プールの使用状況をモニタリング
- [ ] フェイルオーバー動作の確認（本番前）