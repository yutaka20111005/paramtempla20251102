# AWS KMS キー作成パラメータシート

## プロジェクト情報
- **作成日**: 2025-11-02
- **リージョン**: ap-northeast-1 (Tokyo region)
- **用途**: Aurora PostgreSQL Serverless v2、OpenSearch の暗号化

---

## KMSキー #1: Aurora PostgreSQL用

| 項目 | 設定値 | 備考 |
|------|--------|------|
| **基本設定** | | |
| キータイプ | 対称 | データ暗号化用の標準タイプ |
| キー使用法 | 暗号化および復号化 | RDS/Aurora での利用に必須 |
| リージョン | ap-northeast-1 | Tokyo region |
| **詳細オプション** | | |
| キーマテリアルのオリジン | AWS KMS | AWS管理のキーマテリアル使用 |
| 単一リージョンキー / マルチリージョンキー | 単一リージョンキー | DR要件がなければ単一リージョンで十分 |
| **キーの詳細** | | |
| エイリアス | alias/aurora-postgres-serverless-v2 | 用途が明確になるエイリアス名 |
| 説明 | Aurora PostgreSQL Serverless v2 database encryption key | 将来の管理のため詳細を記載 |
| タグ - Name | aurora-postgres-kms-key | リソース識別用 |
| タグ - Environment | production / staging / development | 環境に応じて設定 |
| タグ - Service | Aurora-PostgreSQL | サービス識別用 |
| タグ - ManagedBy | Terraform / Manual | 管理方法を明記 |
| **キーの管理アクセス許可** | | |
| キー管理者 | IAMユーザー/ロール名 | キーの設定変更が可能なユーザー |
| キーの削除を許可 | ☑ (必要に応じて) | 削除権限は慎重に付与 |
| **キーの使用アクセス許可** | | |
| このアカウントでキーを使用できるIAMユーザーとロール | Auroraを起動するIAMロール、管理者ロール | RDSサービスロールも含める |
| 他のAWSアカウント | (必要に応じて) | クロスアカウント利用時のみ |
| AWSサービス統合 | ☑ Amazon RDS | Auroraが自動的にKMSを利用 |
| **キーのローテーション** | | |
| 自動キーローテーション | ☑ 有効 (推奨) | 年1回の自動ローテーション。データキーは自動的に再暗号化されない点に注意 |
| **キーポリシー** | | |
| カスタムキーポリシー | (自動生成 or カスタム) | デフォルトでは自動生成で十分 |

---

## KMSキー #2: OpenSearch用

| 項目 | 設定値 | 備考 |
|------|--------|------|
| **基本設定** | | |
| キータイプ | 対称 | データ暗号化用の標準タイプ |
| キー使用法 | 暗号化および復号化 | OpenSearch での利用に必須 |
| リージョン | ap-northeast-1 | Tokyo region |
| **詳細オプション** | | |
| キーマテリアルのオリジン | AWS KMS | AWS管理のキーマテリアル使用 |
| 単一リージョンキー / マルチリージョンキー | 単一リージョンキー | DR要件がなければ単一リージョンで十分 |
| **キーの詳細** | | |
| エイリアス | alias/opensearch-data-encryption | 用途が明確になるエイリアス名 |
| 説明 | OpenSearch Service data at rest encryption key | 将来の管理のため詳細を記載 |
| タグ - Name | opensearch-kms-key | リソース識別用 |
| タグ - Environment | production / staging / development | 環境に応じて設定 |
| タグ - Service | OpenSearch | サービス識別用 |
| タグ - ManagedBy | Terraform / Manual | 管理方法を明記 |
| **キーの管理アクセス許可** | | |
| キー管理者 | IAMユーザー/ロール名 | キーの設定変更が可能なユーザー |
| キーの削除を許可 | ☑ (必要に応じて) | 削除権限は慎重に付与 |
| **キーの使用アクセス許可** | | |
| このアカウントでキーを使用できるIAMユーザーとロール | OpenSearchを起動するIAMロール、管理者ロール | OpenSearchサービスロールも含める |
| 他のAWSアカウント | (必要に応じて) | クロスアカウント利用時のみ |
| AWSサービス統合 | ☑ Amazon OpenSearch Service | OpenSearchが自動的にKMSを利用 |
| **キーのローテーション** | | |
| 自動キーローテーション | ☑ 有効 (推奨) | 年1回の自動ローテーション。セキュリティベストプラクティス |
| **キーポリシー** | | |
| カスタムキーポリシー | (自動生成 or カスタム) | デフォルトでは自動生成で十分 |

---

## VPCエンドポイント設定 (Private Link利用時)

| 項目 | 設定値 | 備考 |
|------|--------|------|
| **基本設定** | | |
| サービス名 | com.amazonaws.ap-northeast-1.kms | KMS用VPCエンドポイント |
| VPC | 10.0.0.0/16 | 指定されたVPC |
| エンドポイントタイプ | Interface | KMSはInterfaceタイプのみサポート |
| **サブネット設定** | | |
| サブネット1 | 10.0.1.0/24 (ap-northeast-1a) | マルチAZ構成推奨 |
| サブネット2 | 10.0.2.0/24 (ap-northeast-1c) | 高可用性のため |
| **セキュリティグループ** | | |
| インバウンドルール | Port 443, Source: 10.0.0.0/16 | VPC内からのHTTPSアクセス許可 |
| アウトバウンドルール | All traffic (デフォルト) | - |
| **DNS設定** | | |
| プライベートDNS名を有効化 | ☑ 有効 | 有効にするとパブリックエンドポイントの代わりにVPCエンドポイントを使用 |
| **その他** | | |
| エンドポイントポリシー | Full Access (デフォルト) | 必要に応じて制限可能 |
| タグ - Name | kms-vpc-endpoint | 識別用 |

---

## 重要な注意事項

### セキュリティに関する注意
1. **KMSキーの削除**: KMSキーを削除すると、そのキーで暗号化されたデータは永久に復号化できなくなります。削除前に7〜30日の待機期間を設定することを強く推奨します
2. **キーポリシー**: 最小権限の原則に従い、必要最小限のアクセス権限のみを付与してください
3. **CloudTrail統合**: KMSキーの使用状況をCloudTrailで監視することを推奨します

### コストに関する注意
1. **KMSキー料金**: カスタマー管理キーは1つあたり月額$1/月
2. **API呼び出し料金**: 10,000リクエストあたり$0.03 (最初の20,000リクエストは無料/月)
3. **VPCエンドポイント料金**: 時間あたり$0.01/AZ + データ処理料金$0.01/GB

### Private Link利用時の注意
1. VPCエンドポイントを使用する場合、パブリックインターネット経由のKMSアクセスがブロックされる可能性があります
2. プライベートDNSを有効化すると、VPC内のすべてのKMSリクエストが自動的にVPCエンドポイント経由になります
3. VPCエンドポイントのセキュリティグループは、Aurora/OpenSearchからのアクセスを許可する必要があります

### 運用上の注意
1. キーローテーション後も、古いキーマテリアルは自動的に保持され、過去に暗号化されたデータの復号化に使用されます
2. Aurora/OpenSearchの暗号化を有効にした後は、無効化できません
3. 既存の暗号化されていないクラスター/ドメインを暗号化するには、スナップショットから復元が必要です

---

## 作成手順の概要

1. **AWS Management Console** → **KMS** → **カスタマー管理型のキー** → **キーの作成**
2. 上記パラメータに従って、Aurora用とOpenSearch用のキーをそれぞれ作成
3. (Private Link利用時) **VPC** → **エンドポイント** → **エンドポイントの作成**でKMS用VPCエンドポイントを作成
4. Aurora PostgreSQL Serverless v2クラスター作成時に、KMSキーを指定
5. OpenSearchドメイン作成時に、保管データの暗号化でKMSキーを指定

---

## 変更履歴

| 日付 | 変更者 | 変更内容 |
|------|--------|----------|
| 2025-11-02 | - | 初版作成 |
